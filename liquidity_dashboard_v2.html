<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ ë™ì„± ìŠ¤íŠ¸ë ˆìŠ¤ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ v2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .api-setup {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px;
        }

        .api-setup h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .api-setup input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ffc107;
            border-radius: 5px;
            margin: 10px 0;
        }

        .api-setup button {
            background: #ffc107;
            color: #856404;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }

        .api-setup button:hover {
            background: #e0a800;
        }

        .method-selector {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .method-selector label {
            margin-right: 15px;
            color: #0c5460;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .status-panel h2 {
            color: #2a5298;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateX(5px);
        }

        .metric-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2a5298;
        }

        .metric-date {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 5px;
        }

        .metric-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 8px;
            font-weight: 600;
        }

        .status-normal { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-danger { background: #f8d7da; color: #721c24; }
        .status-critical { background: #dc3545; color: white; }

        .chat-container {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .chat-box {
            background: white;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 15px;
            max-width: 80%;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.bot {
            background: #e9ecef;
            color: #333;
        }

        .message.bot strong {
            color: #2a5298;
        }

        .quick-questions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            font-weight: 600;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .input-group button:hover {
            transform: scale(1.05);
        }

        .chart-container {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
            height: 500px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .alert-banner {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
            border: 2px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
            border: 2px solid #c3e6cb;
        }

        .instructions {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦ ì—°ì¤€ ìœ ë™ì„± ìŠ¤íŠ¸ë ˆìŠ¤ ëª¨ë‹ˆí„°ë§</h1>
            <p>ì‹¤ì‹œê°„ RP/RRP/ì§€ì¤€ê¸ˆ/SOFR-IORB ìŠ¤í”„ë ˆë“œ ë¶„ì„ (FRED API ì—°ë™ v2)</p>
        </div>

        <div class="api-setup" id="apiSetup">
            <h3>âš™ï¸ FRED API ì„¤ì •</h3>
            <div class="instructions">
                <strong>ğŸ’¡ CORS ì˜¤ë¥˜ í•´ê²° ë°©ë²•:</strong><br>
                <strong>ë°©ë²• 1:</strong> CORS í”„ë¡ì‹œ ì‚¬ìš© (ìë™ ì„¤ì •ë¨)<br>
                <strong>ë°©ë²• 2:</strong> ë¸Œë¼ìš°ì €ì—ì„œ íŒŒì¼ì„ ì§ì ‘ ì—´ì§€ ë§ê³  ë¡œì»¬ ì„œë²„ë¡œ ì‹¤í–‰<br>
                <strong>ë°©ë²• 3:</strong> ë°ëª¨ ëª¨ë“œ ì‚¬ìš© (API í‚¤ ë¶ˆí•„ìš”)
            </div>

            <div class="method-selector">
                <label>
                    <input type="radio" name="fetchMethod" value="direct" checked> 
                    ì§ì ‘ ì—°ê²° (ê°€ì¥ ë¹ ë¦„)
                </label>
                <label>
                    <input type="radio" name="fetchMethod" value="cors-anywhere"> 
                    CORS Anywhere í”„ë¡ì‹œ
                </label>
                <label>
                    <input type="radio" name="fetchMethod" value="allorigins"> 
                    AllOrigins í”„ë¡ì‹œ
                </label>
            </div>

            <input type="text" id="apiKeyInput" placeholder="FRED API í‚¤: f1137018f7bb4b4150a5c84e09fc7fc2" value="f1137018f7bb4b4150a5c84e09fc7fc2">
            <button onclick="loadData()">ğŸ”„ ë°ì´í„° ë¡œë“œ</button>
            <button onclick="useDemoMode()" style="background: #6c757d;">ğŸ“Š ë°ëª¨ ëª¨ë“œ</button>
        </div>

        <div id="errorDisplay"></div>

        <div class="main-content">
            <!-- ì‹¤ì‹œê°„ ì§€í‘œ íŒ¨ë„ -->
            <div class="status-panel">
                <h2>ğŸ“Š ì‹¤ì‹œê°„ í•µì‹¬ ì§€í‘œ</h2>
                <div id="metricsDisplay">
                    <div class="loading">API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ë°ì´í„°ë¥¼ ë¡œë“œí•˜ì„¸ìš”</div>
                </div>
            </div>

            <!-- ì¢…í•© ìƒíƒœ íŒ¨ë„ -->
            <div class="status-panel">
                <h2>ğŸ¯ ìœ ë™ì„± ìƒíƒœ ë¶„ì„</h2>
                <div id="statusDisplay">
                    <div class="loading">ë°ì´í„° ëŒ€ê¸° ì¤‘...</div>
                </div>
            </div>

            <!-- ì°¨íŠ¸ -->
            <div class="chart-container">
                <canvas id="liquidityChart"></canvas>
            </div>

            <!-- ì±—ë´‡ -->
            <div class="chat-container">
                <h2 style="color: #2a5298; margin-bottom: 20px;">ğŸ’¬ ìœ ë™ì„± ë¶„ì„ AI ì–´ì‹œìŠ¤í„´íŠ¸</h2>
                
                <div class="quick-questions">
                    <button class="quick-btn" onclick="askQuestion('í˜„ì¬ ìœ ë™ì„± ìƒíƒœëŠ”?')">í˜„ì¬ ìœ ë™ì„± ìƒíƒœëŠ”?</button>
                    <button class="quick-btn" onclick="askQuestion('RRPê°€ ë‚®ìœ¼ë©´ ìœ„í—˜í•œê°€?')">RRPê°€ ë‚®ìœ¼ë©´ ìœ„í—˜í•œê°€?</button>
                    <button class="quick-btn" onclick="askQuestion('ìŠ¤í”„ë ˆë“œê°€ ì˜ë¯¸í•˜ëŠ” ê²ƒì€?')">ìŠ¤í”„ë ˆë“œ ì˜ë¯¸ëŠ”?</button>
                    <button class="quick-btn" onclick="askQuestion('ìœ„ê¸° ì‹ í˜¸ëŠ”?')">ìœ„ê¸° ì‹ í˜¸ëŠ”?</button>
                </div>

                <div class="chat-box" id="chatBox">
                    <div class="message bot">
                        ì•ˆë…•í•˜ì„¸ìš”! ì—°ì¤€ ìœ ë™ì„± ë¶„ì„ AIì…ë‹ˆë‹¤. ê¶ê¸ˆí•˜ì‹  ì ì„ ë¬¼ì–´ë³´ì„¸ìš”. ğŸ¤–
                    </div>
                </div>

                <div class="input-group">
                    <input type="text" id="userInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                           onkeypress="if(event.key==='Enter') sendMessage()">
                    <button onclick="sendMessage()">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ë°ì´í„° ì €ì¥ì†Œ
        let liquidityData = {
            rp: null,
            rrp: null,
            reserves: null,
            sofr: null,
            iorb: null,
            spread: null,
            dates: {
                rp: null,
                rrp: null,
                reserves: null,
                sofr: null,
                iorb: null
            },
            history: {
                dates: [],
                rp: [],
                rrp: [],
                spread: []
            }
        };

        let chart = null;
        let apiKey = null;
        let demoMode = false;

        // CORS í”„ë¡ì‹œ ì˜µì…˜
        const CORS_PROXIES = {
            'direct': '',
            'cors-anywhere': 'https://cors-anywhere.herokuapp.com/',
            'allorigins': 'https://api.allorigins.win/raw?url='
        };

        function getSelectedProxy() {
            const selected = document.querySelector('input[name="fetchMethod"]:checked').value;
            return CORS_PROXIES[selected];
        }

        // FRED APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchFREDSeries(seriesId) {
            if (demoMode) {
                return generateDemoData(seriesId);
            }

            if (!apiKey) {
                throw new Error('API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤');
            }

            const baseUrl = `https://api.stlouisfed.org/fred/series/observations`;
            const params = new URLSearchParams({
                series_id: seriesId,
                api_key: apiKey,
                file_type: 'json',
                sort_order: 'desc',
                limit: 100
            });

            const url = `${baseUrl}?${params}`;
            const proxy = getSelectedProxy();
            const fetchUrl = proxy ? `${proxy}${encodeURIComponent(url)}` : url;

            console.log(`Fetching ${seriesId} from:`, fetchUrl);

            try {
                const response = await fetch(fetchUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.observations) {
                    throw new Error('Invalid API response');
                }

                return data.observations;
            } catch (error) {
                console.error(`Error fetching ${seriesId}:`, error);
                throw error;
            }
        }

        // ë°ëª¨ ë°ì´í„° ìƒì„±
        function generateDemoData(seriesId) {
            const now = new Date();
            const observations = [];
            
            for (let i = 99; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                let value;
                switch(seriesId) {
                    case 'RPONTSYD':
                        value = (3.4 + Math.random() * 5).toFixed(3);
                        break;
                    case 'RRPONTSYD':
                        value = (250 + Math.random() * 100).toFixed(3);
                        break;
                    case 'WRESBAL':
                        value = (3400 + Math.random() * 200).toFixed(3);
                        break;
                    case 'SOFR':
                        value = (5.30 + Math.random() * 0.1).toFixed(4);
                        break;
                    case 'IORB':
                        value = (5.15).toFixed(4);
                        break;
                }
                
                observations.push({
                    date: dateStr,
                    value: value
                });
            }
            
            return observations;
        }

        // ìµœì‹  ê°’ ê°€ì ¸ì˜¤ê¸°
        function getLatestValue(observations) {
            if (!observations || observations.length === 0) return null;
            
            for (let i = 0; i < observations.length; i++) {
                if (observations[i].value !== '.') {
                    return {
                        value: parseFloat(observations[i].value),
                        date: observations[i].date
                    };
                }
            }
            return null;
        }

        // ì „ì²´ ë°ì´í„° ë¡œë“œ
        async function loadData() {
            const apiKeyInput = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKeyInput && !demoMode) {
                showError('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            apiKey = apiKeyInput;
            clearMessages();
            document.getElementById('metricsDisplay').innerHTML = '<div class="loading">â³ ë°ì´í„° ë¡œë”© ì¤‘...</div>';
            document.getElementById('statusDisplay').innerHTML = '<div class="loading">â³ ë¶„ì„ ì¤‘...</div>';

            try {
                addMessage('ğŸ”„ FRED APIì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...', 'bot');

                // ë³‘ë ¬ë¡œ ëª¨ë“  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const [rpData, rrpData, reservesData, sofrData, iorbData] = await Promise.all([
                    fetchFREDSeries('RPONTSYD'),
                    fetchFREDSeries('RRPONTSYD'),
                    fetchFREDSeries('WRESBAL'),
                    fetchFREDSeries('SOFR'),
                    fetchFREDSeries('IORB')
                ]);

                // ìµœì‹  ê°’ ì¶”ì¶œ
                const rp = getLatestValue(rpData);
                const rrp = getLatestValue(rrpData);
                const reserves = getLatestValue(reservesData);
                const sofr = getLatestValue(sofrData);
                const iorb = getLatestValue(iorbData);

                if (!rp || !rrp || !reserves || !sofr || !iorb) {
                    throw new Error('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                liquidityData.rp = rp.value;
                liquidityData.rrp = rrp.value;
                liquidityData.reserves = reserves.value;
                liquidityData.sofr = sofr.value;
                liquidityData.iorb = iorb.value;
                liquidityData.spread = (sofr.value - iorb.value) * 100;

                liquidityData.dates.rp = rp.date;
                liquidityData.dates.rrp = rrp.date;
                liquidityData.dates.reserves = reserves.date;
                liquidityData.dates.sofr = sofr.date;
                liquidityData.dates.iorb = iorb.date;

                // íˆìŠ¤í† ë¦¬ ë°ì´í„° ì €ì¥
                liquidityData.history.dates = rpData.slice(0, 30).reverse().map(d => d.date);
                liquidityData.history.rp = rpData.slice(0, 30).reverse().map(d => d.value === '.' ? null : parseFloat(d.value));
                liquidityData.history.rrp = rrpData.slice(0, 30).reverse().map(d => d.value === '.' ? null : parseFloat(d.value));
                
                liquidityData.history.spread = [];
                for (let i = 0; i < 30; i++) {
                    const s = sofrData[i] && sofrData[i].value !== '.' ? parseFloat(sofrData[i].value) : null;
                    const io = iorbData[i] && iorbData[i].value !== '.' ? parseFloat(iorbData[i].value) : null;
                    if (s !== null && io !== null) {
                        liquidityData.history.spread.push((s - io) * 100);
                    } else {
                        liquidityData.history.spread.push(null);
                    }
                }
                liquidityData.history.spread.reverse();

                updateMetricsDisplay();
                updateStatusDisplay();
                updateChart();

                document.getElementById('errorDisplay').innerHTML = 
                    `<div class="success">âœ… ì„±ê³µì ìœ¼ë¡œ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤!</div>`;

                addMessage('âœ… ì‹¤ì‹œê°„ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ìµœì‹  ìˆ˜ì¹˜ëŠ” ìœ„ íŒ¨ë„ì„ í™•ì¸í•˜ì„¸ìš”.', 'bot');

            } catch (error) {
                console.error('Data loading error:', error);
                showError(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}<br><br>` +
                         `<strong>í•´ê²° ë°©ë²•:</strong><br>` +
                         `1. ë‹¤ë¥¸ í”„ë¡ì‹œ ë°©ë²• ì„ íƒ<br>` +
                         `2. ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ë¹„í™œì„±í™”<br>` +
                         `3. "ë°ëª¨ ëª¨ë“œ" ë²„íŠ¼ìœ¼ë¡œ ìƒ˜í”Œ ë°ì´í„° í™•ì¸<br>` +
                         `4. ë¡œì»¬ ì„œë²„ë¡œ íŒŒì¼ ì‹¤í–‰ (python -m http.server)`);
                
                addMessage('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. ë°ëª¨ ëª¨ë“œë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.', 'bot');
            }
        }

        function useDemoMode() {
            demoMode = true;
            addMessage('ğŸ“Š ë°ëª¨ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤ì œì™€ ìœ ì‚¬í•œ ìƒ˜í”Œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.', 'bot');
            loadData();
        }

        function showError(message) {
            document.getElementById('errorDisplay').innerHTML = 
                `<div class="error"><strong>âŒ ì˜¤ë¥˜:</strong><br>${message}</div>`;
        }

        function clearMessages() {
            document.getElementById('errorDisplay').innerHTML = '';
        }

        // ì§€í‘œ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateMetricsDisplay() {
            const html = `
                <div class="metric-card">
                    <div class="metric-label">RP (í™˜ë§¤ì¡°ê±´ë¶€ì±„ê¶Œ)</div>
                    <div class="metric-value">$${liquidityData.rp.toFixed(2)}B</div>
                    <div class="metric-date">ğŸ“… ${liquidityData.dates.rp}</div>
                    <span class="metric-status ${liquidityData.rp > 30 ? 'status-warning' : 'status-normal'}">
                        ${liquidityData.rp > 30 ? 'âš ï¸ ê¸‰ì¦' : 'âœ… ì •ìƒ'}
                    </span>
                </div>
                <div class="metric-card">
                    <div class="metric-label">RRP (ì—­ë ˆí¬)</div>
                    <div class="metric-value">$${liquidityData.rrp.toFixed(2)}B</div>
                    <div class="metric-date">ğŸ“… ${liquidityData.dates.rrp}</div>
                    <span class="metric-status ${liquidityData.rrp < 100 ? 'status-danger' : 'status-normal'}">
                        ${liquidityData.rrp < 100 ? 'ğŸš¨ ì €ì ' : 'âœ… ì •ìƒ'}
                    </span>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ì€í–‰ ì§€ì¤€ê¸ˆ</div>
                    <div class="metric-value">$${liquidityData.reserves.toFixed(2)}B</div>
                    <div class="metric-date">ğŸ“… ${liquidityData.dates.reserves}</div>
                    <span class="metric-status status-normal">âœ… ì •ìƒ</span>
                </div>
                <div class="metric-card">
                    <div class="metric-label">SOFR - IORB ìŠ¤í”„ë ˆë“œ</div>
                    <div class="metric-value">${liquidityData.spread.toFixed(2)} bps</div>
                    <div class="metric-date">ğŸ“… SOFR: ${liquidityData.sofr.toFixed(4)}% | IORB: ${liquidityData.iorb.toFixed(4)}%</div>
                    <span class="metric-status ${
                        liquidityData.spread > 100 ? 'status-critical' : 
                        liquidityData.spread > 20 ? 'status-warning' : 'status-normal'
                    }">
                        ${liquidityData.spread > 100 ? 'ğŸš¨ ê¸´ì¥' : 
                          liquidityData.spread > 20 ? 'âš ï¸ ê²½ê³ ' : 'âœ… ì •ìƒ'}
                    </span>
                </div>
            `;
            document.getElementById('metricsDisplay').innerHTML = html;
        }

        // ìƒíƒœ ë¶„ì„ ì—…ë°ì´íŠ¸
        function updateStatusDisplay() {
            let overallStatus = 'âœ… ì •ìƒ';
            let statusClass = 'status-normal';
            let analysis = '';

            if (liquidityData.spread > 100) {
                overallStatus = 'ğŸš¨ ìœ ë™ì„± ê¸´ì¥';
                statusClass = 'status-critical';
                analysis = `ìê¸ˆ ì¡°ë‹¬ ë¹„ìš©ì´ <strong>${liquidityData.spread.toFixed(2)}bps</strong>ë¡œ ê¸‰ë“±í–ˆìŠµë‹ˆë‹¤. ì‹œì¥ ìŠ¤íŠ¸ë ˆìŠ¤ ì§•í›„ì…ë‹ˆë‹¤.`;
            } else if (liquidityData.spread > 20 || liquidityData.rrp < 100) {
                overallStatus = 'âš ï¸ ì£¼ì˜ í•„ìš”';
                statusClass = 'status-warning';
                analysis = `ìœ ë™ì„± ì§€í‘œì— ê²½ê³  ì‹ í˜¸ê°€ ë‚˜íƒ€ë‚˜ê³  ìˆìŠµë‹ˆë‹¤. RRPëŠ” <strong>$${liquidityData.rrp.toFixed(2)}B</strong>, ìŠ¤í”„ë ˆë“œëŠ” <strong>${liquidityData.spread.toFixed(2)}bps</strong>ì…ë‹ˆë‹¤.`;
            } else if (liquidityData.rp > 30) {
                overallStatus = 'âš ï¸ ëª¨ë‹ˆí„°ë§';
                statusClass = 'status-warning';
                analysis = `RPê°€ <strong>$${liquidityData.rp.toFixed(2)}B</strong>ë¡œ ì¦ê°€í•˜ê³  ìˆì–´ ë‹¨ê¸° ìê¸ˆ ìˆ˜ìš”ê°€ ë†’ìŠµë‹ˆë‹¤.`;
            } else {
                overallStatus = 'âœ… ì–‘í˜¸';
                statusClass = 'status-normal';
                analysis = 'ëª¨ë“  ìœ ë™ì„± ì§€í‘œê°€ ì •ìƒ ë²”ìœ„ì…ë‹ˆë‹¤.';
            }

            const html = `
                <div class="alert-banner ${statusClass}">
                    ${overallStatus}
                </div>
                <div style="padding: 20px; background: white; border-radius: 10px;">
                    <h3 style="color: #2a5298; margin-bottom: 15px;">ğŸ“ˆ ì¢…í•© ë¶„ì„</h3>
                    <p style="line-height: 1.8; color: #495057;">${analysis}</p>
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #dee2e6;">
                    <div style="font-size: 0.9em; color: #6c757d;">
                        <strong>í˜„ì¬ ìˆ˜ì¹˜ (${demoMode ? 'ë°ëª¨' : 'ì‹¤ì‹œê°„'}):</strong><br>
                        â€¢ RP: $${liquidityData.rp.toFixed(2)}B (ê²½ê³ : >$30B)<br>
                        â€¢ RRP: $${liquidityData.rrp.toFixed(2)}B (ê²½ê³ : <$100B)<br>
                        â€¢ ìŠ¤í”„ë ˆë“œ: ${liquidityData.spread.toFixed(2)}bps (ê²½ê³ : >20bps, ê¸´ì¥: >100bps)<br>
                        â€¢ ì§€ì¤€ê¸ˆ: $${liquidityData.reserves.toFixed(2)}B
                    </div>
                </div>
            `;
            document.getElementById('statusDisplay').innerHTML = html;
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateChart() {
            const ctx = document.getElementById('liquidityChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: liquidityData.history.dates,
                    datasets: [
                        {
                            label: 'RP ($B)',
                            data: liquidityData.history.rp,
                            borderColor: '#20c997',
                            backgroundColor: 'rgba(32, 201, 151, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            spanGaps: true
                        },
                        {
                            label: 'RRP ($B)',
                            data: liquidityData.history.rrp,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            spanGaps: true
                        },
                        {
                            label: 'SOFR-IORB (bps)',
                            data: liquidityData.history.spread,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `ìœ ë™ì„± ì§€í‘œ 30ì¼ ì¶”ì´ (${demoMode ? 'ë°ëª¨ ë°ì´í„°' : 'FRED ì‹¤ì‹œê°„ ë°ì´í„°'})`,
                            font: { size: 18, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'RP / RRP (ì‹­ì–µë‹¬ëŸ¬)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'SOFR-IORB (bps)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        // ì±—ë´‡ ì§ˆë¬¸ ì²˜ë¦¬
        const qaDatabase = {
            'í˜„ì¬ ìœ ë™ì„± ìƒíƒœ': () => {
                if (!liquidityData.rp) {
                    return 'ë¨¼ì € ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”!';
                }

                let status = '';
                if (liquidityData.spread > 100) {
                    status = `ğŸš¨ <strong>ìœ ë™ì„± ê¸´ì¥ ìƒíƒœ</strong>ì…ë‹ˆë‹¤. SOFR-IORB ìŠ¤í”„ë ˆë“œê°€ <strong>${liquidityData.spread.toFixed(2)}bps</strong>ë¡œ 100bpsë¥¼ ì´ˆê³¼í•˜ì—¬ ìê¸ˆ ì¡°ë‹¬ ë¹„ìš©ì´ ê¸‰ë“±í–ˆìŠµë‹ˆë‹¤.`;
                } else if (liquidityData.spread > 20) {
                    status = `âš ï¸ <strong>ì£¼ì˜ê°€ í•„ìš”</strong>í•œ ìƒíƒœì…ë‹ˆë‹¤. ìŠ¤í”„ë ˆë“œê°€ <strong>${liquidityData.spread.toFixed(2)}bps</strong>ë¡œ ê²½ê³  ìˆ˜ì¤€ì…ë‹ˆë‹¤.`;
                } else {
                    status = `âœ… <strong>ì–‘í˜¸í•œ ìƒíƒœ</strong>ì…ë‹ˆë‹¤. RPëŠ” <strong>$${liquidityData.rp.toFixed(2)}B</strong>, RRPëŠ” <strong>$${liquidityData.rrp.toFixed(2)}B</strong>ì…ë‹ˆë‹¤.`;
                }
                return status;
            },
            'rrp': () => {
                const current = liquidityData.rrp ? liquidityData.rrp.toFixed(2) : 'ë°ì´í„° ì—†ìŒ';
                return `<strong>RRP (ì—­ë ˆí¬)</strong>ëŠ” ì—°ì¤€ì´ ì‹œì¥ì˜ ì´ˆê³¼ ìœ ë™ì„±ì„ í¡ìˆ˜í•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.<br><br>` +
                       `ğŸ“Š í˜„ì¬ RRP: <strong>$${current}B</strong><br><br>` +
                       `100ì–µ ë‹¬ëŸ¬ ì´í•˜ë¡œ ë–¨ì–´ì§€ë©´ ì‹œì¥ì˜ í˜„ê¸ˆ ë¶€ì¡± ì‹ í˜¸ì…ë‹ˆë‹¤.`;
            },
            'ìŠ¤í”„ë ˆë“œ': () => {
                const current = liquidityData.spread ? liquidityData.spread.toFixed(2) : 'ë°ì´í„° ì—†ìŒ';
                return `<strong>SOFR-IORB ìŠ¤í”„ë ˆë“œ</strong>ëŠ” ì‹œì¥ ìê¸ˆ ì¡°ë‹¬ ë¹„ìš©ê³¼ ì—°ì¤€ ê¸°ì¤€ê¸ˆë¦¬ì˜ ì°¨ì´ì…ë‹ˆë‹¤.<br><br>` +
                       `ğŸ“Š í˜„ì¬: <strong>${current} bps</strong><br>` +
                       `ğŸ“Š SOFR: <strong>${liquidityData.sofr ? liquidityData.sofr.toFixed(4) : '-'}%</strong><br>` +
                       `ğŸ“Š IORB: <strong>${liquidityData.iorb ? liquidityData.iorb.toFixed(4) : '-'}%</strong>`;
            },
            'ìœ„ê¸°': () => {
                return `<strong>ğŸš¨ ìœ ë™ì„± ìœ„ê¸° ì‹ í˜¸:</strong><br><br>` +
                       `í˜„ì¬ ìˆ˜ì¹˜:<br>` +
                       `â€¢ RP: $${liquidityData.rp ? liquidityData.rp.toFixed(2) : '-'}B ${liquidityData.rp > 30 ? 'âš ï¸' : 'âœ…'}<br>` +
                       `â€¢ RRP: $${liquidityData.rrp ? liquidityData.rrp.toFixed(2) : '-'}B ${liquidityData.rrp < 100 ? 'ğŸš¨' : 'âœ…'}<br>` +
                       `â€¢ ìŠ¤í”„ë ˆë“œ: ${liquidityData.spread ? liquidityData.spread.toFixed(2) : '-'} bps ${liquidityData.spread > 100 ? 'ğŸš¨' : liquidityData.spread > 20 ? 'âš ï¸' : 'âœ…'}`;
            },
            'rp': () => {
                const current = liquidityData.rp ? liquidityData.rp.toFixed(2) : 'ë°ì´í„° ì—†ìŒ';
                return `<strong>RP (í™˜ë§¤ì¡°ê±´ë¶€ì±„ê¶Œ)</strong>ëŠ” ì—°ì¤€ì´ ì‹œì¥ì— ë‹¨ê¸° ìœ ë™ì„±ì„ ê³µê¸‰í•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.<br><br>` +
                       `ğŸ“Š í˜„ì¬ RP: <strong>$${current}B</strong>`;
            }
        };

        function askQuestion(question) {
            addMessage(question, 'user');
            
            setTimeout(() => {
                let answer = '';
                const q = question.toLowerCase();
                
                if (q.includes('ìƒíƒœ') || q.includes('í˜„ì¬')) {
                    answer = qaDatabase['í˜„ì¬ ìœ ë™ì„± ìƒíƒœ']();
                } else if (q.includes('rrp') || q.includes('ì—­ë ˆí¬')) {
                    answer = qaDatabase['rrp']();
                } else if (q.includes('ìŠ¤í”„ë ˆë“œ') || q.includes('sofr')) {
                    answer = qaDatabase['ìŠ¤í”„ë ˆë“œ']();
                } else if (q.includes('ìœ„ê¸°') || q.includes('ì‹ í˜¸') || q.includes('ìœ„í—˜')) {
                    answer = qaDatabase['ìœ„ê¸°']();
                } else if (q.includes('rp') || q.includes('í™˜ë§¤')) {
                    answer = qaDatabase['rp']();
                } else if (q.includes('ì§€ì¤€ê¸ˆ') || q.includes('ì¤€ë¹„ê¸ˆ')) {
                    answer = `<strong>ì€í–‰ ì§€ì¤€ê¸ˆ</strong>ì€ ì€í–‰ë“¤ì´ ì—°ì¤€ì— ì˜ˆì¹˜í•œ ì§€ê¸‰ì¤€ë¹„ê¸ˆì…ë‹ˆë‹¤.<br><br>` +
                             `ğŸ“Š í˜„ì¬: <strong>$${liquidityData.reserves ? liquidityData.reserves.toFixed(2) : '-'}B</strong>`;
                } else {
                    answer = `ë‹¤ìŒ ì£¼ì œì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”:<br>` +
                             `â€¢ í˜„ì¬ ìœ ë™ì„± ìƒíƒœ<br>` +
                             `â€¢ RP, RRP, ì§€ì¤€ê¸ˆ<br>` +
                             `â€¢ SOFR-IORB ìŠ¤í”„ë ˆë“œ<br>` +
                             `â€¢ ìœ ë™ì„± ìœ„ê¸° ì‹ í˜¸`;
                }
                
                addMessage(answer, 'bot');
            }, 500);
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const question = input.value.trim();
            
            if (question) {
                askQuestion(question);
                input.value = '';
            }
        }

        function addMessage(text, type) {
            const chatBox = document.getElementById('chatBox');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.innerHTML = text;
            chatBox.appendChild(message);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ API í‚¤ ìë™ ì…ë ¥
        window.addEventListener('load', () => {
            addMessage('ğŸ’¡ <strong>ë¹ ë¥¸ ì‹œì‘:</strong> API í‚¤ê°€ ì´ë¯¸ ì…ë ¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤. "ë°ì´í„° ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜, CORS ì˜¤ë¥˜ ë°œìƒ ì‹œ ë‹¤ë¥¸ í”„ë¡ì‹œ ë°©ë²•ì„ ì„ íƒí•˜ê±°ë‚˜ "ë°ëª¨ ëª¨ë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'bot');
        });
    </script>
</body>
</html>
